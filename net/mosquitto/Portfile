# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1

name                mosquitto
version             2.0.20
revision            0

categories          net devel
license             {EPL-1 EDL-1}

maintainers         {gmail.com:slewsys @slewsys} openmaintainer

description         Mosquitto is an open-source MQTT 3.1/3.1.1 broker

long_description    \
    MQTT is an OASIS standard messaging protocol for the Internet of Things (IoT). \
    Mosquitto is an open source implementation of a server for version 5.0, 3.1.1, \
    and 3.1 of the MQTT protocol. It also includes a C and C++ client library, and \
    the mosquitto_pub and mosquitto_sub utilities for publishing and subscribing.

homepage            https://mosquitto.org
master_sites        ${homepage}/files/source/

checksums           rmd160  0e030b778f914da49b8436ef3d635090e120e1d3 \
                    sha256  ebd07d89d2a446a7f74100ad51272e4a8bf300b61634a7812e19f068f2759de8 \
                    size    799972

depends_build-append \
                    path:bin/xsltproc:libxslt \
                    port:docbook-xsl-nons

depends_lib         port:c-ares \
                    port:libcjson \
                    port:libwebsockets \
                    port:tcp_wrappers \
                    path:lib/libssl.dylib:openssl

depends_test-append \
                    port:cunit \
                    port:python312

configure.args-append \
                    -DUSE_LIBWRAP:BOOL=ON \
                    -DWITH_SRV:BOOL=ON \
                    -DWITH_WEBSOCKETS:BOOL=ON

test.run            no

pre-build {
    reinplace -E "s|\\.so\\.\[^\[:space:\]\]+|.dylib |g" ${worksrcpath}/config.mk
}

set mosquitto_user  mosquitto
set mosquitto_group mosquitto

add_users ${mosquitto_user} group=${mosquitto_group} shell=/bin/sh \
    home=${prefix}/var/lib/${name} realname=Mosquitto\ MQTT\ Server

startupitem.create  yes
startupitem.init    \
    "MOSQUITTO=${prefix}/sbin/mosquitto"
startupitem.start    \
    "su ${mosquitto_user} -c \"\${MOSQUITTO}\""
startupitem.stop    \
    "su ${mosquitto_user} -c \"\pkill -U ${mosquitto_user} mosquitto\""

livecheck.type  regex
livecheck.url   ${master_sites}
livecheck.regex ${name}-(\\d+\\.\\d+\\.\\d+)\\.tar
